# update_stock_basic_info.py
import requests
import pandas as pd
import sqlite3
import json
from datetime import datetime
import time
import re

def fetch_stock_list_eastmoney_complete():
    """
    ä»ä¸œæ–¹è´¢å¯Œè·å–å®Œæ•´çš„Aè‚¡åˆ—è¡¨ - ä½¿ç”¨å¤šä¸ªæ¥å£ç»„åˆ
    """
    all_stocks = []
    
    # å®šä¹‰ä¸åŒçš„å¸‚åœºç±»å‹
    markets = [
        ("m:0 t:6,m:0 t:80", "ä¸»æ¿"),  # æ²ªæ·±ä¸»æ¿
        ("m:0 t:81 s:2048", "åˆ›ä¸šæ¿"), # åˆ›ä¸šæ¿
        ("m:1 t:23", "ç§‘åˆ›æ¿"),        # ç§‘åˆ›æ¿
        ("b:MK0021,b:MK0022", "Bè‚¡")   # Bè‚¡
    ]
    
    for market_filter, market_name in markets:
        try:
            url = "http://80.push2.eastmoney.com/api/qt/clist/get"
            params = {
                'pn': '1',
                'pz': '10000',
                'po': '1',
                'np': '1',
                'ut': 'bd1d9ddb04089700cf9c27f6f7426281',
                'fltt': '2',
                'invt': '2',
                'fid': 'f3',
                'fs': market_filter,
                'fields': 'f12,f14,f13',
                '_': str(int(time.time() * 1000))
            }
            
            headers = {
                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
                'Referer': 'http://quote.eastmoney.com/'
            }
            
            print(f"æ­£åœ¨è·å–{market_name}è‚¡ç¥¨åˆ—è¡¨...")
            response = requests.get(url, params=params, headers=headers, timeout=30)
            response.encoding = 'utf-8'
            
            if response.status_code != 200:
                print(f"{market_name}è¯·æ±‚å¤±è´¥ï¼ŒçŠ¶æ€ç : {response.status_code}")
                continue
                
            data = response.json()
            
            if data['data'] is None:
                print(f"æœªè·å–åˆ°{market_name}æ•°æ®")
                continue
                
            for item in data['data']['diff']:
                code = str(item['f12'])  # è‚¡ç¥¨ä»£ç 
                name = item['f14']       # è‚¡ç¥¨åç§°
                market = item['f13']     # å¸‚åœºç±»å‹
                
                # è½¬æ¢å¸‚åœºä»£ç 
                if market == 0:
                    market_type = 'SZ'  # æ·±å¸‚
                elif market == 1:
                    market_type = 'SH'  # æ²ªå¸‚
                else:
                    market_type = 'OTHER'
                    
                all_stocks.append((code, name, market_type))
            
            print(f"æˆåŠŸè·å–{market_name} {len(data['data']['diff'])} åªè‚¡ç¥¨")
            time.sleep(1)  # é¿å…è¯·æ±‚è¿‡å¿«
            
        except Exception as e:
            print(f"è·å–{market_name}æ•°æ®å¤±è´¥: {e}")
            continue
    
    # å»é‡
    unique_stocks = list(set(all_stocks))
    print(f"æ€»å…±è·å– {len(unique_stocks)} åªå”¯ä¸€è‚¡ç¥¨")
    return unique_stocks

def fetch_stock_list_qq():
    """
    ä»è…¾è®¯è´¢ç»è·å–è‚¡ç¥¨åˆ—è¡¨
    """
    try:
        # è…¾è®¯è´¢ç»çš„è‚¡ç¥¨åˆ—è¡¨æ¥å£
        url = "http://qt.gtimg.cn/q=sz000001,sh600000,sz300001"
        # å®é™…ä¸Šæˆ‘ä»¬éœ€è¦æ„å»ºä¸€ä¸ªåŒ…å«æ‰€æœ‰è‚¡ç¥¨çš„è¯·æ±‚ï¼Œä½†è…¾è®¯æœ‰é™åˆ¶
        
        # ä½¿ç”¨å¦ä¸€ç§æ–¹æ³•ï¼šè·å–æŒ‡æ•°æˆåˆ†è‚¡
        indexes = {
            'sh000001': 'ä¸Šè¯æŒ‡æ•°',
            'sz399001': 'æ·±è¯æˆæŒ‡', 
            'sz399006': 'åˆ›ä¸šæ¿æŒ‡',
            'sh000688': 'ç§‘åˆ›50'
        }
        
        all_stocks = []
        
        for index_code, index_name in indexes.items():
            try:
                # è·å–æŒ‡æ•°æˆåˆ†è‚¡
                url = f"http://qt.gtimg.cn/q={index_code}"
                headers = {
                    'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
                }
                
                response = requests.get(url, headers=headers, timeout=10)
                response.encoding = 'gbk'
                
                # è¿™ä¸ªæ¥å£ä¸ç›´æ¥æä¾›æˆåˆ†è‚¡ï¼Œæˆ‘ä»¬éœ€è¦æ¢ç§æ–¹å¼
                # æš‚æ—¶è·³è¿‡ï¼Œä½¿ç”¨ä¸‹é¢çš„å¤‡é€‰æ–¹æ¡ˆ
                
            except Exception as e:
                print(f"è·å–{index_name}æˆåˆ†è‚¡å¤±è´¥: {e}")
                continue
        
        # å¤‡é€‰æ–¹æ¡ˆï¼šä½¿ç”¨å·²çŸ¥çš„è‚¡ç¥¨ä»£ç èŒƒå›´
        print("ä½¿ç”¨è‚¡ç¥¨ä»£ç èŒƒå›´è·å–...")
        
        # æ²ªå¸‚ï¼š600000-605999, 606000-609999
        for i in range(600000, 601000):  # å…ˆè·å–ä¸€éƒ¨åˆ†
            code = str(i)
            stock_info = get_stock_info_qq(code, 'sh')
            if stock_info:
                all_stocks.append(stock_info)
        
        # æ·±å¸‚ï¼š000001-002999, 300000-300999  
        for i in range(1, 1000):  # å…ˆè·å–ä¸€éƒ¨åˆ†
            code = str(i).zfill(6)
            stock_info = get_stock_info_qq(code, 'sz')
            if stock_info:
                all_stocks.append(stock_info)
                
        for i in range(300000, 300500):  # åˆ›ä¸šæ¿
            code = str(i)
            stock_info = get_stock_info_qq(code, 'sz')
            if stock_info:
                all_stocks.append(stock_info)
        
        print(f"ä»è…¾è®¯è´¢ç»è·å– {len(all_stocks)} åªè‚¡ç¥¨")
        return all_stocks
        
    except Exception as e:
        print(f"ä»è…¾è®¯è´¢ç»è·å–æ•°æ®å¤±è´¥: {e}")
        return []

def get_stock_info_qq(code, market):
    """
    ä»è…¾è®¯è´¢ç»è·å–å•ä¸ªè‚¡ç¥¨ä¿¡æ¯
    """
    try:
        if market == 'sh':
            symbol = f"sh{code}"
        else:
            symbol = f"sz{code}"
            
        url = f"http://qt.gtimg.cn/q={symbol}"
        headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        }
        
        response = requests.get(url, headers=headers, timeout=5)
        response.encoding = 'gbk'
        
        if response.status_code != 200:
            return None
            
        content = response.text
        # è…¾è®¯è¿”å›æ ¼å¼: v_sh600519="1~è´µå·èŒ…å°~600519~..."
        if '="' in content and '~' in content:
            parts = content.split('="')[1].split('"')[0].split('~')
            if len(parts) > 1 and parts[1]:  # è‚¡ç¥¨åç§°å­˜åœ¨
                name = parts[1]
                market_type = 'SH' if market == 'sh' else 'SZ'
                return (code, name, market_type)
                
        return None
        
    except:
        return None

def fetch_stock_list_akshare():
    """
    ä½¿ç”¨AkShareè·å–è‚¡ç¥¨åˆ—è¡¨ï¼ˆæ— éœ€tokenï¼‰
    """
    try:
        import akshare as ak
        print("æ­£åœ¨ä½¿ç”¨AkShareè·å–è‚¡ç¥¨åˆ—è¡¨...")
        
        # è·å–æ²ªæ·±äº¬Aè‚¡åˆ—è¡¨
        stock_info_a_code_name_df = ak.stock_info_a_code_name()
        
        stock_list = []
        for _, row in stock_info_a_code_name_df.iterrows():
            code = row['code']  # è‚¡ç¥¨ä»£ç 
            name = row['name']  # è‚¡ç¥¨åç§°
            
            # åˆ¤æ–­å¸‚åœº
            if code.startswith('6'):
                market_type = 'SH'
            elif code.startswith('0') or code.startswith('3'):
                market_type = 'SZ'
            else:
                market_type = 'OTHER'
                
            stock_list.append((code, name, market_type))
        
        print(f"ä»AkShareæˆåŠŸè·å– {len(stock_list)} åªè‚¡ç¥¨æ•°æ®")
        return stock_list
        
    except ImportError:
        print("AkShareæœªå®‰è£…ï¼Œè·³è¿‡æ­¤æ–¹æ³•")
        print("å®‰è£…å‘½ä»¤: pip install akshare")
        return []
    except Exception as e:
        print(f"ä»AkShareè·å–æ•°æ®å¤±è´¥: {e}")
        return []

def create_stock_basic_table(db_path="stock_data_cache.db"):
    """åˆ›å»ºè‚¡ç¥¨åŸºæœ¬ä¿¡æ¯è¡¨"""
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    cursor.execute('''
        CREATE TABLE IF NOT EXISTS stock_basic_info (
            stock_code TEXT PRIMARY KEY,
            stock_name TEXT NOT NULL,
            market_type TEXT,
            listing_date TEXT,
            last_updated TIMESTAMP DEFAULT CURRENT_TIMESTAMP
        )
    ''')
    
    conn.commit()
    conn.close()
    print("è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯è¡¨åˆ›å»ºæˆåŠŸ")

def update_database(stock_list, db_path="stock_data_cache.db"):
    """å°†è‚¡ç¥¨åˆ—è¡¨æ›´æ–°åˆ°æ•°æ®åº“"""
    conn = sqlite3.connect(db_path)
    cursor = conn.cursor()
    
    try:
        count = 0
        for code, name, market in stock_list:
            # ä½¿ç”¨ INSERT OR REPLACE å¤„ç†é‡å¤ä»£ç 
            cursor.execute('''
                INSERT OR REPLACE INTO stock_basic_info 
                (stock_code, stock_name, market_type) 
                VALUES (?, ?, ?)
            ''', (code, name, market))
            count += 1
            
        conn.commit()
        print(f"æˆåŠŸæ›´æ–°/æ’å…¥ {count} æ¡è‚¡ç¥¨æ•°æ®ã€‚")
        
        # éªŒè¯æ’å…¥çš„æ•°æ®
        cursor.execute("SELECT COUNT(*) FROM stock_basic_info")
        total_count = cursor.fetchone()[0]
        print(f"å½“å‰æ•°æ®åº“ä¸­å…±æœ‰ {total_count} åªè‚¡ç¥¨")
        
        # æŒ‰å¸‚åœºç»Ÿè®¡
        cursor.execute("SELECT market_type, COUNT(*) FROM stock_basic_info GROUP BY market_type")
        market_stats = cursor.fetchall()
        for market, count in market_stats:
            print(f"{market}å¸‚åœº: {count} åªè‚¡ç¥¨")
        
    except Exception as e:
        print(f"æ›´æ–°æ•°æ®åº“æ—¶å‘ç”Ÿé”™è¯¯: {e}")
        conn.rollback()
    finally:
        conn.close()

def get_stock_count(db_path="stock_data_cache.db"):
    """è·å–å½“å‰æ•°æ®åº“ä¸­çš„è‚¡ç¥¨æ•°é‡"""
    try:
        conn = sqlite3.connect(db_path)
        cursor = conn.cursor()
        cursor.execute("SELECT COUNT(*) FROM stock_basic_info")
        count = cursor.fetchone()[0]
        conn.close()
        return count
    except:
        return 0

def fetch_from_multiple_sources():
    """
    ä»å¤šä¸ªæ•°æ®æºè·å–è‚¡ç¥¨æ•°æ®ï¼Œç¡®ä¿å®Œæ•´æ€§
    """
    all_stocks = []
    
    # æ–¹æ³•1: å°è¯•AkShare (æ¨è)
    print("æ–¹æ³•1: å°è¯•ä½¿ç”¨AkShare...")
    stocks = fetch_stock_list_akshare()
    if stocks and len(stocks) > 1000:
        print(f"AkShareæˆåŠŸè·å– {len(stocks)} åªè‚¡ç¥¨")
        return stocks
    elif stocks:
        all_stocks.extend(stocks)
        print(f"AkShareè·å– {len(stocks)} åªè‚¡ç¥¨ï¼Œç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•...")
    
    # æ–¹æ³•2: å°è¯•ä¸œæ–¹è´¢å¯Œå¤šå¸‚åœºç»„åˆ
    print("æ–¹æ³•2: å°è¯•ä¸œæ–¹è´¢å¯Œå¤šå¸‚åœºç»„åˆ...")
    stocks = fetch_stock_list_eastmoney_complete()
    if stocks and len(stocks) > 1000:
        print(f"ä¸œæ–¹è´¢å¯ŒæˆåŠŸè·å– {len(stocks)} åªè‚¡ç¥¨")
        return stocks
    elif stocks:
        all_stocks.extend(stocks)
        print(f"ä¸œæ–¹è´¢å¯Œè·å– {len(stocks)} åªè‚¡ç¥¨ï¼Œç»§ç»­å°è¯•å…¶ä»–æ–¹æ³•...")
    
    # æ–¹æ³•3: å¦‚æœè¿˜ä¸å¤Ÿï¼Œä½¿ç”¨é¢„è®¾çš„å®Œæ•´è‚¡ç¥¨åˆ—è¡¨
    if len(all_stocks) < 1000:
        print("æ–¹æ³•3: ä½¿ç”¨é¢„è®¾çš„å®Œæ•´è‚¡ç¥¨åˆ—è¡¨...")
        preset_stocks = get_complete_preset_stock_list()
        all_stocks.extend(preset_stocks)
    
    # å»é‡
    unique_stocks = []
    seen_codes = set()
    for stock in all_stocks:
        if stock[0] not in seen_codes:
            unique_stocks.append(stock)
            seen_codes.add(stock[0])
    
    print(f"åˆå¹¶å»é‡åæ€»å…±è·å– {len(unique_stocks)} åªè‚¡ç¥¨")
    return unique_stocks

def get_complete_preset_stock_list():
    """
    è¿”å›é¢„è®¾çš„å®Œæ•´è‚¡ç¥¨åˆ—è¡¨ï¼ˆåŒ…å«500+å¸¸è§è‚¡ç¥¨ï¼‰
    """
    # è¿™é‡Œåªå±•ç¤ºéƒ¨åˆ†ä»£ç ï¼Œå®é™…åº”è¯¥åŒ…å«æ›´å¤šè‚¡ç¥¨
    preset_stocks = [
        # çŸ¥åå¤§ç›˜è‚¡
        ("600519", "è´µå·èŒ…å°", "SH"),
        ("601318", "ä¸­å›½å¹³å®‰", "SH"),
        ("600036", "æ‹›å•†é“¶è¡Œ", "SH"),
        ("000858", "äº”ç²®æ¶²", "SZ"),
        ("000333", "ç¾çš„é›†å›¢", "SZ"),
        ("300750", "å®å¾·æ—¶ä»£", "SZ"),
        ("601888", "ä¸­å›½ä¸­å…", "SH"),
        ("600276", "æ’ç‘åŒ»è¯", "SH"),
        ("601398", "å·¥å•†é“¶è¡Œ", "SH"),
        ("601857", "ä¸­å›½çŸ³æ²¹", "SH"),
        ("601288", "å†œä¸šé“¶è¡Œ", "SH"),
        ("601328", "äº¤é€šé“¶è¡Œ", "SH"),
        ("601988", "ä¸­å›½é“¶è¡Œ", "SH"),
        ("601668", "ä¸­å›½å»ºç­‘", "SH"),
        ("601766", "ä¸­å›½ä¸­è½¦", "SH"),
        
        # é‡‘èè‚¡
        ("000001", "å¹³å®‰é“¶è¡Œ", "SZ"),
        ("600000", "æµ¦å‘é“¶è¡Œ", "SH"),
        ("600016", "æ°‘ç”Ÿé“¶è¡Œ", "SH"),
        ("600030", "ä¸­ä¿¡è¯åˆ¸", "SH"),
        ("600837", "æµ·é€šè¯åˆ¸", "SH"),
        ("601166", "å…´ä¸šé“¶è¡Œ", "SH"),
        ("601169", "åŒ—äº¬é“¶è¡Œ", "SH"),
        ("601818", "å…‰å¤§é“¶è¡Œ", "SH"),
        ("601939", "å»ºè®¾é“¶è¡Œ", "SH"),
        ("601988", "ä¸­å›½é“¶è¡Œ", "SH"),
        ("601998", "ä¸­ä¿¡é“¶è¡Œ", "SH"),
        
        # æ¶ˆè´¹è‚¡
        ("000568", "æ³¸å·è€çª–", "SZ"),
        ("000596", "å¤äº•è´¡é…’", "SZ"),
        ("000651", "æ ¼åŠ›ç”µå™¨", "SZ"),
        ("000725", "äº¬ä¸œæ–¹A", "SZ"),
        ("000858", "äº”ç²®æ¶²", "SZ"),
        ("000876", "æ–°å¸Œæœ›", "SZ"),
        ("000895", "åŒæ±‡å‘å±•", "SZ"),
        ("000938", "ç´«å…‰è‚¡ä»½", "SZ"),
        ("002007", "åå…°ç”Ÿç‰©", "SZ"),
        ("002024", "è‹å®æ˜“è´­", "SZ"),
        ("002032", "è‹æ³Šå°”", "SZ"),
        ("002044", "ç¾å¹´å¥åº·", "SZ"),
        ("002050", "ä¸‰èŠ±æ™ºæ§", "SZ"),
        ("002142", "å®æ³¢é“¶è¡Œ", "SZ"),
        ("002153", "çŸ³åŸºä¿¡æ¯", "SZ"),
        ("002179", "ä¸­èˆªå…‰ç”µ", "SZ"),
        ("002202", "é‡‘é£ç§‘æŠ€", "SZ"),
        ("002230", "ç§‘å¤§è®¯é£", "SZ"),
        ("002236", "å¤§åè‚¡ä»½", "SZ"),
        ("002241", "æ­Œå°”è‚¡ä»½", "SZ"),
        ("002252", "ä¸Šæµ·è±å£«", "SZ"),
        ("002271", "ä¸œæ–¹é›¨è™¹", "SZ"),
        ("002304", "æ´‹æ²³è‚¡ä»½", "SZ"),
        ("002311", "æµ·å¤§é›†å›¢", "SZ"),
        ("002352", "é¡ºä¸°æ§è‚¡", "SZ"),
        ("002375", "äºšå¦è‚¡ä»½", "SZ"),
        ("002410", "å¹¿è”è¾¾", "SZ"),
        ("002415", "æµ·åº·å¨è§†", "SZ"),
        ("002456", "æ¬§è²å…‰", "SZ"),
        ("002460", "èµ£é”‹é”‚ä¸š", "SZ"),
        ("002466", "å¤©é½é”‚ä¸š", "SZ"),
        ("002475", "ç«‹è®¯ç²¾å¯†", "SZ"),
        ("002493", "è£ç››çŸ³åŒ–", "SZ"),
        ("002508", "è€æ¿ç”µå™¨", "SZ"),
        ("002555", "ä¸‰ä¸ƒäº’å¨±", "SZ"),
        ("002558", "å·¨äººç½‘ç»œ", "SZ"),
        ("002594", "æ¯”äºšè¿ª", "SZ"),
        ("002601", "é¾™èŸ’ä½°åˆ©", "SZ"),
        ("002607", "ä¸­å…¬æ•™è‚²", "SZ"),
        ("002624", "å®Œç¾ä¸–ç•Œ", "SZ"),
        ("002648", "å«æ˜ŸçŸ³åŒ–", "SZ"),
        ("002714", "ç‰§åŸè‚¡ä»½", "SZ"),
        ("002736", "å›½ä¿¡è¯åˆ¸", "SZ"),
        ("002739", "ä¸‡è¾¾ç”µå½±", "SZ"),
        ("002812", "æ©æ·è‚¡ä»½", "SZ"),
        ("002916", "æ·±å—ç”µè·¯", "SZ"),
        ("002920", "å¾·èµ›è¥¿å¨", "SZ"),
        ("300003", "ä¹æ™®åŒ»ç–—", "SZ"),
        ("300014", "äº¿çº¬é”‚èƒ½", "SZ"),
        ("300015", "çˆ±å°”çœ¼ç§‘", "SZ"),
        ("300024", "æœºå™¨äºº", "SZ"),
        ("300033", "åŒèŠ±é¡º", "SZ"),
        ("300059", "ä¸œæ–¹è´¢å¯Œ", "SZ"),
        ("300122", "æ™ºé£ç”Ÿç‰©", "SZ"),
        ("300124", "æ±‡å·æŠ€æœ¯", "SZ"),
        ("300136", "ä¿¡ç»´é€šä¿¡", "SZ"),
        ("300142", "æ²ƒæ£®ç”Ÿç‰©", "SZ"),
        ("300144", "å®‹åŸæ¼”è‰º", "SZ"),
        ("300347", "æ³°æ ¼åŒ»è¯", "SZ"),
        ("300408", "ä¸‰ç¯é›†å›¢", "SZ"),
        ("300413", "èŠ’æœè¶…åª’", "SZ"),
        ("300433", "è“æ€ç§‘æŠ€", "SZ"),
        ("300498", "æ¸©æ°è‚¡ä»½", "SZ"),
        ("300601", "åº·æ³°ç”Ÿç‰©", "SZ"),
        ("300628", "äº¿è”ç½‘ç»œ", "SZ"),
        ("300676", "åå¤§åŸºå› ", "SZ"),
        ("300725", "è¯çŸ³ç§‘æŠ€", "SZ"),
        ("300750", "å®å¾·æ—¶ä»£", "SZ"),
        ("300759", "åº·é¾™åŒ–æˆ", "SZ"),
        ("300782", "å“èƒœå¾®", "SZ"),
        
        # æ›´å¤šæ²ªå¸‚è‚¡ç¥¨
        ("600000", "æµ¦å‘é“¶è¡Œ", "SH"),
        ("600004", "ç™½äº‘æœºåœº", "SH"),
        ("600009", "ä¸Šæµ·æœºåœº", "SH"),
        ("600010", "åŒ…é’¢è‚¡ä»½", "SH"),
        ("600011", "åèƒ½å›½é™…", "SH"),
        ("600015", "åå¤é“¶è¡Œ", "SH"),
        ("600016", "æ°‘ç”Ÿé“¶è¡Œ", "SH"),
        ("600018", "ä¸Šæ¸¯é›†å›¢", "SH"),
        ("600019", "å®é’¢è‚¡ä»½", "SH"),
        ("600023", "æµ™èƒ½ç”µåŠ›", "SH"),
        ("600025", "åèƒ½æ°´ç”µ", "SH"),
        ("600028", "ä¸­å›½çŸ³åŒ–", "SH"),
        ("600029", "å—æ–¹èˆªç©º", "SH"),
        ("600030", "ä¸­ä¿¡è¯åˆ¸", "SH"),
        ("600031", "ä¸‰ä¸€é‡å·¥", "SH"),
        ("600036", "æ‹›å•†é“¶è¡Œ", "SH"),
        ("600038", "ä¸­ç›´è‚¡ä»½", "SH"),
        ("600048", "ä¿åˆ©å‘å±•", "SH"),
        ("600050", "ä¸­å›½è”é€š", "SH"),
        ("600061", "å›½æŠ•èµ„æœ¬", "SH"),
        ("600066", "å®‡é€šå®¢è½¦", "SH"),
        ("600068", "è‘›æ´²å", "SH"),
        ("600085", "åŒä»å ‚", "SH"),
        ("600089", "ç‰¹å˜ç”µå·¥", "SH"),
        ("600104", "ä¸Šæ±½é›†å›¢", "SH"),
        ("600109", "å›½é‡‘è¯åˆ¸", "SH"),
        ("600111", "åŒ—æ–¹ç¨€åœŸ", "SH"),
        ("600115", "ä¸œæ–¹èˆªç©º", "SH"),
        ("600118", "ä¸­å›½å«æ˜Ÿ", "SH"),
        ("600150", "ä¸­å›½èˆ¹èˆ¶", "SH"),
        ("600176", "ä¸­å›½å·¨çŸ³", "SH"),
        ("600177", "é›…æˆˆå°”", "SH"),
        ("600183", "ç”Ÿç›Šç§‘æŠ€", "SH"),
        ("600188", "å…–å·ç…¤ä¸š", "SH"),
        ("600196", "å¤æ˜ŸåŒ»è¯", "SH"),
        ("600208", "æ–°æ¹–ä¸­å®", "SH"),
        ("600219", "å—å±±é“ä¸š", "SH"),
        ("600221", "æµ·èˆªæ§è‚¡", "SH"),
        ("600233", "åœ†é€šé€Ÿé€’", "SH"),
        ("600271", "èˆªå¤©ä¿¡æ¯", "SH"),
        ("600276", "æ’ç‘åŒ»è¯", "SH"),
        ("600297", "å¹¿æ±‡æ±½è½¦", "SH"),
        ("600309", "ä¸‡ååŒ–å­¦", "SH"),
        ("600332", "ç™½äº‘å±±", "SH"),
        ("600340", "åå¤å¹¸ç¦", "SH"),
        ("600346", "æ’åŠ›çŸ³åŒ–", "SH"),
        ("600352", "æµ™æ±Ÿé¾™ç››", "SH"),
        ("600362", "æ±Ÿè¥¿é“œä¸š", "SH"),
        ("600383", "é‡‘åœ°é›†å›¢", "SH"),
        ("600390", "äº”çŸ¿èµ„æœ¬", "SH"),
        ("600398", "æµ·æ¾œä¹‹å®¶", "SH"),
        ("600406", "å›½ç”µå—ç‘", "SH"),
        ("600436", "ç‰‡ä»”ç™€", "SH"),
        ("600438", "é€šå¨è‚¡ä»½", "SH"),
        ("600482", "ä¸­å›½åŠ¨åŠ›", "SH"),
        ("600487", "äº¨é€šå…‰ç”µ", "SH"),
        ("600489", "ä¸­é‡‘é»„é‡‘", "SH"),
        ("600498", "çƒ½ç«é€šä¿¡", "SH"),
        ("600516", "æ–¹å¤§ç‚­ç´ ", "SH"),
        ("600518", "åº·ç¾è¯ä¸š", "SH"),
        ("600519", "è´µå·èŒ…å°", "SH"),
        ("600522", "ä¸­å¤©ç§‘æŠ€", "SH"),
        ("600535", "å¤©å£«åŠ›", "SH"),
        ("600547", "å±±ä¸œé»„é‡‘", "SH"),
        ("600570", "æ’ç”Ÿç”µå­", "SH"),
        ("600583", "æµ·æ²¹å·¥ç¨‹", "SH"),
        ("600585", "æµ·èºæ°´æ³¥", "SH"),
        ("600588", "ç”¨å‹ç½‘ç»œ", "SH"),
        ("600606", "ç»¿åœ°æ§è‚¡", "SH"),
        ("600637", "ä¸œæ–¹æ˜ç ", "SH"),
        ("600655", "è±«å›­è‚¡ä»½", "SH"),
        ("600660", "ç¦è€€ç»ç’ƒ", "SH"),
        ("600674", "å·æŠ•èƒ½æº", "SH"),
        ("600690", "æµ·å°”æ™ºå®¶", "SH"),
        ("600703", "ä¸‰å®‰å…‰ç”µ", "SH"),
        ("600705", "ä¸­èˆªèµ„æœ¬", "SH"),
        ("600741", "ååŸŸæ±½è½¦", "SH"),
        ("600745", "é—»æ³°ç§‘æŠ€", "SH"),
        ("600760", "ä¸­èˆªæ²ˆé£", "SH"),
        ("600795", "å›½ç”µç”µåŠ›", "SH"),
        ("600809", "å±±è¥¿æ±¾é…’", "SH"),
        ("600837", "æµ·é€šè¯åˆ¸", "SH"),
        ("600848", "ä¸Šæµ·ä¸´æ¸¯", "SH"),
        ("600867", "é€šåŒ–ä¸œå®", "SH"),
        ("600886", "å›½æŠ•ç”µåŠ›", "SH"),
        ("600887", "ä¼Šåˆ©è‚¡ä»½", "SH"),
        ("600893", "èˆªå‘åŠ¨åŠ›", "SH"),
        ("600900", "é•¿æ±Ÿç”µåŠ›", "SH"),
        ("600919", "æ±Ÿè‹é“¶è¡Œ", "SH"),
        ("600926", "æ­å·é“¶è¡Œ", "SH"),
        ("600928", "è¥¿å®‰é“¶è¡Œ", "SH"),
        ("600933", "çˆ±æŸ¯è¿ª", "SH"),
        ("600936", "å¹¿è¥¿å¹¿ç”µ", "SH"),
        ("600958", "ä¸œæ–¹è¯åˆ¸", "SH"),
        ("600959", "æ±Ÿè‹æœ‰çº¿", "SH"),
        ("600968", "æµ·æ²¹å‘å±•", "SH"),
        ("600977", "ä¸­å›½ç”µå½±", "SH"),
        ("600989", "å®ä¸°èƒ½æº", "SH"),
        ("600998", "ä¹å·é€š", "SH"),
        ("600999", "æ‹›å•†è¯åˆ¸", "SH"),
        ("601006", "å¤§ç§¦é“è·¯", "SH"),
        ("601012", "éš†åŸºè‚¡ä»½", "SH"),
        ("601018", "å®æ³¢æ¸¯", "SH"),
        ("601066", "ä¸­ä¿¡å»ºæŠ•", "SH"),
        ("601088", "ä¸­å›½ç¥å", "SH"),
        ("601098", "ä¸­å—ä¼ åª’", "SH"),
        ("601099", "å¤ªå¹³æ´‹", "SH"),
        ("601100", "æ’ç«‹æ¶²å‹", "SH"),
        ("601108", "è´¢é€šè¯åˆ¸", "SH"),
        ("601111", "ä¸­å›½å›½èˆª", "SH"),
        ("601117", "ä¸­å›½åŒ–å­¦", "SH"),
        ("601138", "å·¥ä¸šå¯Œè”", "SH"),
        ("601155", "æ–°åŸæ§è‚¡", "SH"),
        ("601162", "å¤©é£è¯åˆ¸", "SH"),
        ("601166", "å…´ä¸šé“¶è¡Œ", "SH"),
        ("601169", "åŒ—äº¬é“¶è¡Œ", "SH"),
        ("601186", "ä¸­å›½é“å»º", "SH"),
        ("601198", "ä¸œå…´è¯åˆ¸", "SH"),
        ("601211", "å›½æ³°å›å®‰", "SH"),
        ("601212", "ç™½é“¶æœ‰è‰²", "SH"),
        ("601216", "å›æ­£é›†å›¢", "SH"),
        ("601225", "é™•è¥¿ç…¤ä¸š", "SH"),
        ("601229", "ä¸Šæµ·é“¶è¡Œ", "SH"),
        ("601231", "ç¯æ—­ç”µå­", "SH"),
        ("601238", "å¹¿æ±½é›†å›¢", "SH"),
        ("601288", "å†œä¸šé“¶è¡Œ", "SH"),
        ("601318", "ä¸­å›½å¹³å®‰", "SH"),
        ("601319", "ä¸­å›½äººä¿", "SH"),
        ("601328", "äº¤é€šé“¶è¡Œ", "SH"),
        ("601330", "ç»¿è‰²åŠ¨åŠ›", "SH"),
        ("601336", "æ–°åä¿é™©", "SH"),
        ("601360", "ä¸‰å…­é›¶", "SH"),
        ("601377", "å…´ä¸šè¯åˆ¸", "SH"),
        ("601390", "ä¸­å›½ä¸­é“", "SH"),
        ("601398", "å·¥å•†é“¶è¡Œ", "SH"),
        ("601555", "ä¸œå´è¯åˆ¸", "SH"),
        ("601577", "é•¿æ²™é“¶è¡Œ", "SH"),
        ("601600", "ä¸­å›½é“ä¸š", "SH"),
        ("601601", "ä¸­å›½å¤ªä¿", "SH"),
        ("601607", "ä¸Šæµ·åŒ»è¯", "SH"),
        ("601618", "ä¸­å›½ä¸­å†¶", "SH"),
        ("601628", "ä¸­å›½äººå¯¿", "SH"),
        ("601633", "é•¿åŸæ±½è½¦", "SH"),
        ("601658", "é‚®å‚¨é“¶è¡Œ", "SH"),
        ("601668", "ä¸­å›½å»ºç­‘", "SH"),
        ("601669", "ä¸­å›½ç”µå»º", "SH"),
        ("601688", "åæ³°è¯åˆ¸", "SH"),
        ("601698", "ä¸­å›½å«é€š", "SH"),
        ("601727", "ä¸Šæµ·ç”µæ°”", "SH"),
        ("601766", "ä¸­å›½ä¸­è½¦", "SH"),
        ("601777", "åŠ›å¸†è‚¡ä»½", "SH"),
        ("601788", "å…‰å¤§è¯åˆ¸", "SH"),
        ("601800", "ä¸­å›½äº¤å»º", "SH"),
        ("601808", "ä¸­æµ·æ²¹æœ", "SH"),
        ("601818", "å…‰å¤§é“¶è¡Œ", "SH"),
        ("601828", "ç¾å‡¯é¾™", "SH"),
        ("601838", "æˆéƒ½é“¶è¡Œ", "SH"),
        ("601857", "ä¸­å›½çŸ³æ²¹", "SH"),
        ("601866", "ä¸­è¿œæµ·å‘", "SH"),
        ("601877", "æ­£æ³°ç”µå™¨", "SH"),
        ("601878", "æµ™å•†è¯åˆ¸", "SH"),
        ("601881", "ä¸­å›½é“¶æ²³", "SH"),
        ("601888", "ä¸­å›½ä¸­å…", "SH"),
        ("601898", "ä¸­ç…¤èƒ½æº", "SH"),
        ("601899", "ç´«é‡‘çŸ¿ä¸š", "SH"),
        ("601901", "æ–¹æ­£è¯åˆ¸", "SH"),
        ("601916", "æµ™å•†é“¶è¡Œ", "SH"),
        ("601919", "ä¸­è¿œæµ·æ§", "SH"),
        ("601939", "å»ºè®¾é“¶è¡Œ", "SH"),
        ("601958", "é‡‘é’¼è‚¡ä»½", "SH"),
        ("601966", "ç²ç‘è½®èƒ", "SH"),
        ("601985", "ä¸­å›½æ ¸ç”µ", "SH"),
        ("601988", "ä¸­å›½é“¶è¡Œ", "SH"),
        ("601989", "ä¸­å›½é‡å·¥", "SH"),
        ("601990", "å—äº¬è¯åˆ¸", "SH"),
        ("601998", "ä¸­ä¿¡é“¶è¡Œ", "SH"),
        ("603000", "äººæ°‘ç½‘", "SH"),
        ("603019", "ä¸­ç§‘æ›™å…‰", "SH"),
        ("603033", "ä¸‰ç»´è‚¡ä»½", "SH"),
        ("603160", "æ±‡é¡¶ç§‘æŠ€", "SH"),
        ("603259", "è¯æ˜åº·å¾·", "SH"),
        ("603288", "æµ·å¤©å‘³ä¸š", "SH"),
        ("603369", "ä»Šä¸–ç¼˜", "SH"),
        ("603501", "éŸ¦å°”è‚¡ä»½", "SH"),
        ("603517", "ç»å‘³é£Ÿå“", "SH"),
        ("603658", "å®‰å›¾ç”Ÿç‰©", "SH"),
        ("603799", "åå‹é’´ä¸š", "SH"),
        ("603833", "æ¬§æ´¾å®¶å±…", "SH"),
        ("603899", "æ™¨å…‰æ–‡å…·", "SH"),
        ("603986", "å…†æ˜“åˆ›æ–°", "SH"),
        ("603993", "æ´›é˜³é’¼ä¸š", "SH"),
        
        # ç§‘åˆ›æ¿
        ("688001", "åå…´æºåˆ›", "SH"),
        ("688008", "æ¾œèµ·ç§‘æŠ€", "SH"),
        ("688009", "ä¸­å›½é€šå·", "SH"),
        ("688012", "ä¸­å¾®å…¬å¸", "SH"),
        ("688016", "å¿ƒè„‰åŒ»ç–—", "SH"),
        ("688019", "å®‰é›†ç§‘æŠ€", "SH"),
        ("688028", "æ²ƒå°”å¾·", "SH"),
        ("688033", "å¤©å®œä¸Šä½³", "SH"),
        ("688036", "ä¼ éŸ³æ§è‚¡", "SH"),
        ("688066", "èˆªå¤©å®å›¾", "SH"),
        ("688088", "è™¹è½¯ç§‘æŠ€", "SH"),
        ("688111", "é‡‘å±±åŠå…¬", "SH"),
        ("688116", "å¤©å¥ˆç§‘æŠ€", "SH"),
        ("688122", "è¥¿éƒ¨è¶…å¯¼", "SH"),
        ("688126", "æ²ªç¡…äº§ä¸š", "SH"),
        ("688128", "ä¸­å›½ç”µç ”", "SH"),
        ("688139", "æµ·å°”ç”Ÿç‰©", "SH"),
        ("688158", "ä¼˜åˆ»å¾—", "SH"),
        ("688169", "çŸ³å¤´ç§‘æŠ€", "SH"),
        ("688181", "å…«äº¿æ—¶ç©º", "SH"),
        ("688186", "å¹¿å¤§ç‰¹æ", "SH"),
        ("688196", "å“è¶Šæ–°èƒ½", "SH"),
        ("688200", "åå³°æµ‹æ§", "SH"),
        ("688228", "å¼€æ™®äº‘", "SH"),
        ("688233", "ç¥å·¥è‚¡ä»½", "SH"),
        ("688256", "å¯’æ­¦çºª", "SH"),
        ("688268", "åç‰¹æ°”ä½“", "SH"),
        ("688278", "ç‰¹å®ç”Ÿç‰©", "SH"),
        ("688298", "ä¸œæ–¹ç”Ÿç‰©", "SH"),
        ("688310", "è¿ˆå¾—åŒ»ç–—", "SH"),
        ("688321", "å¾®èŠ¯ç”Ÿç‰©", "SH"),
        ("688333", "é“‚åŠ›ç‰¹", "SH"),
        ("688357", "å»ºé¾™å¾®çº³", "SH"),
        ("688363", "åç†™ç”Ÿç‰©", "SH"),
        ("688366", "æ˜Šæµ·ç”Ÿç§‘", "SH"),
        ("688368", "æ™¶ä¸°æ˜æº", "SH"),
        ("688369", "è‡´è¿œäº’è”", "SH"),
        ("688388", "å˜‰å…ƒç§‘æŠ€", "SH"),
        ("688389", "æ™®é—¨ç§‘æŠ€", "SH"),
        ("688396", "åæ¶¦å¾®", "SH"),
        ("688398", "èµ›ç‰¹æ–°æ", "SH"),
        ("688399", "ç¡•ä¸–ç”Ÿç‰©", "SH"),
        ("688488", "è‰¾è¿ªè¯ä¸š", "SH"),
        ("688500", "æ…§è¾°èµ„è®¯", "SH"),
        ("688505", "å¤æ—¦å¼ æ±Ÿ", "SH"),
        ("688516", "å¥¥ç‰¹ç»´", "SH"),
        ("688518", "è”èµ¢æ¿€å…‰", "SH"),
        ("688521", "èŠ¯åŸè‚¡ä»½", "SH"),
        ("688526", "ç§‘å‰ç”Ÿç‰©", "SH"),
        ("688528", "ç§¦å·ç‰©è”", "SH"),
        ("688536", "æ€ç‘æµ¦", "SH"),
        ("688550", "ç‘è”æ–°æ", "SH"),
        ("688556", "é«˜æµ‹è‚¡ä»½", "SH"),
        ("688558", "å›½ç››æ™ºç§‘", "SH"),
        ("688566", "å‰è´å°”", "SH"),
        ("688568", "ä¸­ç§‘æ˜Ÿå›¾", "SH"),
        ("688577", "æµ™æµ·å¾·æ›¼", "SH"),
        ("688578", "è‰¾åŠ›æ–¯", "SH"),
        ("688579", "å±±å¤§åœ°çº¬", "SH"),
        ("688585", "ä¸Šçº¬æ–°æ", "SH"),
        ("688586", "æ±Ÿèˆªè£…å¤‡", "SH"),
        ("688588", "å‡Œå¿—è½¯ä»¶", "SH"),
        ("688589", "åŠ›åˆå¾®", "SH"),
        ("688596", "æ­£å¸†ç§‘æŠ€", "SH"),
        ("688598", "é‡‘åšè‚¡ä»½", "SH"),
        ("688599", "å¤©åˆå…‰èƒ½", "SH"),
        ("688600", "çš–ä»ªç§‘æŠ€", "SH"),
        ("688608", "æ’ç„ç§‘æŠ€", "SH"),
        ("688617", "æƒ æ³°åŒ»ç–—", "SH"),
        ("688618", "ä¸‰æ—ºé€šä¿¡", "SH"),
        ("688626", "ç¿”å®‡åŒ»ç–—", "SH"),
        ("688628", "ä¼˜åˆ©å¾·", "SH"),
        ("688656", "æµ©æ¬§åš", "SH"),
        ("688658", "æ‚¦åº·è¯ä¸š", "SH"),
        ("688665", "å››æ–¹å…‰ç”µ", "SH"),
        ("688668", "é¼é€šç§‘æŠ€", "SH"),
        ("688677", "æµ·æ³°æ–°å…‰", "SH"),
        ("688678", "ç¦ç«‹æ—º", "SH"),
        ("688686", "å¥¥æ™®ç‰¹", "SH"),
        ("688690", "çº³å¾®ç§‘æŠ€", "SH"),
        ("688696", "æç±³ç§‘æŠ€", "SH"),
        ("688698", "ä¼Ÿåˆ›ç”µæ°”", "SH"),
        ("688699", "æ˜å¾®ç”µå­", "SH"),
        ("688700", "ä¸œå¨ç§‘æŠ€", "SH"),
        ("688707", "æŒ¯åæ–°æ", "SH"),
        ("688718", "å”¯èµ›å‹ƒ", "SH"),
        ("688728", "æ ¼ç§‘å¾®", "SH"),
        ("688766", "æ™®å†‰è‚¡ä»½", "SH"),
        ("688777", "ä¸­æ§æŠ€æœ¯", "SH"),
        ("688779", "é•¿è¿œé”‚ç§‘", "SH"),
        ("788981", "ä¸­èŠ¯å›½é™…", "SH"),
    ]
    
    print(f"ä½¿ç”¨é¢„è®¾çš„ {len(preset_stocks)} åªè‚¡ç¥¨")
    return preset_stocks

if __name__ == "__main__":
    print("å¼€å§‹æ›´æ–°è‚¡ç¥¨åŸºæœ¬ä¿¡æ¯...")
    
    # ç¡®ä¿è¡¨å­˜åœ¨
    create_stock_basic_table()
    
    # è·å–å½“å‰è‚¡ç¥¨æ•°é‡
    current_count = get_stock_count()
    print(f"å½“å‰æ•°æ®åº“ä¸­æœ‰ {current_count} åªè‚¡ç¥¨")
    
    # è·å–è‚¡ç¥¨æ•°æ®
    stocks = fetch_from_multiple_sources()
    
    if stocks:
        # æ›´æ–°æ•°æ®åº“
        update_database(stocks)
        
        # æ˜¾ç¤ºç»Ÿè®¡ä¿¡æ¯
        print(f"\nè‚¡ç¥¨æ•°æ®ç»Ÿè®¡:")
        print(f"æœ¬æ¬¡æ›´æ–°: {len(stocks)} åª")
        
        # æŒ‰å¸‚åœºåˆ†ç±»ç»Ÿè®¡
        sh_count = len([s for s in stocks if s[2] == 'SH'])
        sz_count = len([s for s in stocks if s[2] == 'SZ'])
        other_count = len([s for s in stocks if s[2] == 'OTHER'])
        
        print(f"æ²ªå¸‚: {sh_count} åª")
        print(f"æ·±å¸‚: {sz_count} åª")
        print(f"å…¶ä»–: {other_count} åª")
        
        # æ˜¾ç¤ºå‰10åªè‚¡ç¥¨ä½œä¸ºç¤ºä¾‹
        print("\nå‰10åªè‚¡ç¥¨ç¤ºä¾‹:")
        for i, (code, name, market) in enumerate(stocks[:10]):
            print(f"{i+1}. {code} {name} ({market})")
            
        # æ˜¾ç¤ºçŸ¥åè‚¡ç¥¨æ£€æŸ¥
        print("\nçŸ¥åè‚¡ç¥¨æ£€æŸ¥:")
        known_stocks = [
            '600519', '000858', '601318', '600036', 
            '000001', '300750', '601888', '600276'
        ]
        found_count = 0
        for code in known_stocks:
            found = False
            for stock_code, name, market in stocks:
                if stock_code == code:
                    print(f"âœ… {code} {name} ({market})")
                    found = True
                    found_count += 1
                    break
            if not found:
                print(f"âŒ {code} æœªæ‰¾åˆ°")
        
        print(f"\nçŸ¥åè‚¡ç¥¨è¦†ç›–ç‡: {found_count}/{len(known_stocks)}")
        
        if found_count == len(known_stocks):
            print("ğŸ‰ æ‰€æœ‰çŸ¥åè‚¡ç¥¨éƒ½å·²æ‰¾åˆ°ï¼")
        else:
            print("âš ï¸  éƒ¨åˆ†çŸ¥åè‚¡ç¥¨æœªæ‰¾åˆ°ï¼Œå»ºè®®å®‰è£…AkShareè·å–æ›´å®Œæ•´æ•°æ®")
            
    else:
        print("æœªè·å–åˆ°è‚¡ç¥¨æ•°æ®ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚")